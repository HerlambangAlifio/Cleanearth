<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Saya - Clean Earth</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .page-title {
      font-size: 2rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .page-subtitle {
      color: #666;
      margin-bottom: 24px;
    }
    
    .event-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .event-item {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      display: flex;
    }
    
    .event-image {
      width: 200px;
      height: 150px;
      object-fit: cover;
    }
    
    .event-content {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .event-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .registration-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-cancelled {
      background: #f5f5f5;
      color: #666;
    }
    
    .event-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .event-detail {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #555;
    }
    
    .event-detail svg {
      width: 16px;
      height: 16px;
      color: #666;
    }
    
    .event-description {
      color: #666;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    
    .event-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .btn-danger {
      background: #d32f2f;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b71c1c;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: #d32f2f;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #f5f5f5;
      color: #333;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 24px;
      transition: background 0.2s;
    }
    
    .back-btn:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div id="navbar-placeholder"></div>
  
  <div class="container">
    <a href="event_guest.html" class="back-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
        <polyline points="15,18 9,12 15,6"></polyline>
      </svg>
      Kembali ke Event
    </a>
    
    <h1 class="page-title">Event Saya</h1>
    <p class="page-subtitle">Daftar event yang telah Anda ikuti</p>
    
    <div id="myEventsList">
      <div class="loading">Memuat event...</div>
    </div>
  </div>
  
  <script src="js/navbar_public.js"></script>
  <script>
    // Check authentication
    (function() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }
    })();
    
    // Load user's events
    async function loadMyEvents() {
      const eventsList = document.getElementById('myEventsList');
      
      try {
        const response = await fetch('http://localhost:5000/api/event/mine', {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const registrations = await response.json();
        
        if (registrations.length === 0) {
          eventsList.innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <h3>Belum ada event yang diikuti</h3>
              <p>Daftar ke event untuk melihatnya di sini</p>
            </div>
          `;
          return;
        }
        
        eventsList.innerHTML = `
          <div class="event-list">
            ${registrations.map(registration => createEventItem(registration)).join('')}
          </div>
        `;
      } catch (error) {
        console.error('Error loading my events:', error);
        eventsList.innerHTML = `
          <div class="error">
            <h3>Gagal memuat event</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }
    
    function createEventItem(registration) {
      const event = registration.Event;
      const statusText = {
        'pending': 'Menunggu Konfirmasi',
        'approved': 'Diterima',
        'rejected': 'Ditolak',
        'cancelled': 'Dibatalkan'
      };
      
      const statusClass = `status-${registration.status}`;
      const statusLabel = statusText[registration.status] || 'Unknown';
      
      const eventDate = new Date(event.tanggal).toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      const timeRange = `${event.waktu_mulai} - ${event.waktu_selesai}`;
      
      const registrationDate = new Date(registration.tanggal_daftar).toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      return `
        <div class="event-item">
          <img src="http://localhost:5000/uploads/${event.gambar || 'default-event.jpg'}" 
               alt="${event.judul}" 
               class="event-image"
               onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
          
          <div style="display:none; width:200px; height:150px; background:#f0f0f0; border-radius:8px; align-items:center; justify-content:center; font-size:14px; color:#666; margin-right:20px;">
            ðŸ“· Event
          </div>
          
          <div class="event-content">
            <div>
              <div class="event-header">
                <h3 class="event-title">${event.judul}</h3>
                <span class="registration-status ${statusClass}">${statusLabel}</span>
              </div>
              
              <p class="event-description">${event.deskripsi}</p>
              
              <div class="event-details">
                <div class="event-detail">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                  </svg>
                  ${event.lokasi}
                </div>
                <div class="event-detail">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                  ${eventDate}
                </div>
                <div class="event-detail">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12,6 12,12 16,14"></polyline>
                  </svg>
                  ${timeRange}
                </div>
                <div class="event-detail">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                  </svg>
                  Daftar: ${registrationDate}
                </div>
              </div>
            </div>
            
            ${registration.status === 'pending' ? `
              <div class="event-actions">
                <button class="btn btn-danger" onclick="cancelRegistration(${registration.id})">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                  Batalkan Pendaftaran
                </button>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    async function cancelRegistration(registrationId) {
      if (!confirm('Yakin ingin membatalkan pendaftaran ini?')) {
        return;
      }
      
      try {
        const response = await fetch(`http://localhost:5000/api/event/registrations/${registrationId}/status`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          },
          body: JSON.stringify({
            status: 'cancelled'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('Pendaftaran berhasil dibatalkan');
          loadMyEvents(); // Refresh list
        } else {
          alert(data.message || 'Gagal membatalkan pendaftaran');
        }
      } catch (error) {
        console.error('Error cancelling registration:', error);
        alert('Gagal membatalkan pendaftaran');
      }
    }
    
    // Load events when page loads
    document.addEventListener('DOMContentLoaded', loadMyEvents);
  </script>
</body>
</html> 